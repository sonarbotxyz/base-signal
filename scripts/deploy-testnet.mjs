import { createWalletClient, createPublicClient, http, parseEther } from 'viem';
import { privateKeyToAccount } from 'viem/accounts';
import { baseSepolia } from 'viem/chains';

// Deployer private key (this is for testnet only!)
const DEPLOYER_KEY = process.env.DEPLOYER_KEY || '0xd8af422ba9e4cc25060e9e6ea0b9790d914e6670e9891d16857f358ff72abda8';

// Platform signer address
const PLATFORM_SIGNER = '0x789ed3027a7BE03Fb17eb2B4c91854FfF6Bd143E';

// Simple ERC20 bytecode (compiled SonarToken)
// We'll use a minimal ERC20 for testing
const ERC20_BYTECODE = '0x60806040523480156200001157600080fd5b506040518060400160405280600581526020017f536f6e61720000000000000000000000000000000000000000000000000000008152506040518060400160405280600581526020017f534f4e41520000000000000000000000000000000000000000000000000000008152508160039081620000909190620004bb565b508060049081620000a29190620004bb565b505050620000e333620000ba620000e960201b60201c565b6c04ee2d6d415b85acef8100000062000100620000f260201b60201c565b620000fe9190620005d1565b620000fb60201b60201c565b6200068f565b600060129050905600565b60006012905090565b6200010f8282620001c060201b60201c565b50505b505050565b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff16036200018a576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401620001819062000681565b60405180910390fd5b6200019e600083836200022d60201b60201c565b8060026000828254620001b291906200061c565b925050819055506200021c565b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603620001f9578081600254620001f691906200061c565b60025550505050565b8060025403620002105760006002555b505050565b505050565b600081519050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680620002985760e052602060002090565b602082108103620002ae57620002ad6200024c565b5b50919050565b60008190508160005260206000209050919050565b60006020601f19601f840116949350505050565b60008190508160005260206000209050919050565b60006020601f19601f840116949350505050565b828183375060008183015250505050565b60005b83811015620003395780820151818401526020810190506200031c565b60008484015250505050565b600082825260208201905092915050565b600082825260208201905092915050565b6000601f19601f8301169050919050565b6000620003858262000225565b62000391818562000345565b9350620003a381856020860162000317565b620003ae8162000367565b840191505092915050565b60006020820190508181036000830152620003d5818462000378565b905092915050565b60006020820190508181036000830152620003f98184620003d5565b905092915050565b600060ff82169050919050565b6200041a818362000401565b505050565b600060028204905092915050565b600062000440620004388462000401565b8362000401565b90509291505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000620004868262000401565b9150620004938362000401565b9250828202620004a38162000401565b9150828204831483151715620004be57620004bd62000449565b5b5092915050565b600081905092915050565b6000620004dd8262000225565b620004e98185620004c5565b9350620004fb81856020860162000317565b80840191505092915050565b6000620005158284620004d0565b915081905092915050565b60008160011c9050919050565b600060ff83166200054a836200051e60201b60201c565b9050919050565b600082821b905092915050565b60006008830262000592837ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc6200052d565b6200059e868362000551565b95508019841693508086168417925050509291505050565b6000819050919050565b6000620005e1620005db620005d584620005b6565b620005b6565b620005b6565b9050919050565b600081905091905056';

// Vault bytecode - simplified for testnet
const VAULT_ABI = [
  'constructor(address _token, address _platformSigner)',
  'function deposit(uint256 amount) external',
  'function withdraw(uint256 amount, uint256 nonce, bytes calldata signature) external',
  'function token() external view returns (address)',
  'function platformSigner() external view returns (address)',
  'function getNonce(address user) external view returns (uint256)',
  'function vaultBalance() external view returns (uint256)',
  'event Deposited(address indexed user, uint256 amount, uint256 timestamp)',
  'event Withdrawn(address indexed user, uint256 amount, uint256 nonce, uint256 timestamp)'
];

async function main() {
  console.log('üöÄ Deploying to Base Sepolia testnet...\n');
  
  const account = privateKeyToAccount(DEPLOYER_KEY);
  console.log('Deployer:', account.address);
  
  const publicClient = createPublicClient({
    chain: baseSepolia,
    transport: http('https://sepolia.base.org'),
  });
  
  const walletClient = createWalletClient({
    account,
    chain: baseSepolia,
    transport: http('https://sepolia.base.org'),
  });
  
  // Check balance
  const balance = await publicClient.getBalance({ address: account.address });
  console.log('Balance:', balance.toString(), 'wei');
  
  if (balance === 0n) {
    console.log('\n‚ö†Ô∏è  No ETH on Base Sepolia!');
    console.log('Get testnet ETH from: https://www.coinbase.com/faucets/base-ethereum-sepolia-faucet');
    console.log('Deployer address:', account.address);
    return;
  }
  
  console.log('\n‚úÖ Ready to deploy');
  console.log('Platform Signer:', PLATFORM_SIGNER);
  console.log('\nTo deploy, you need to compile the contracts with Foundry or Hardhat.');
  console.log('Run: forge build && forge create SonarToken --rpc-url https://sepolia.base.org --private-key $DEPLOYER_KEY');
}

main().catch(console.error);
